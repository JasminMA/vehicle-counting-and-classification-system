# Vehicle Counting System - Implementation Plan

## Overview
Complete implementation roadmap for building the vehicle counting system using AWS CDK, CloudFormation, and CI/CD best practices. This plan breaks down the project into manageable phases with clear deliverables.

## Technology Stack

### Infrastructure as Code:
- **AWS CDK** (TypeScript) - Primary IaC tool
- **CloudFormation** - Generated by CDK
- **Node.js/npm** - CDK runtime and package management
- **AWS CLI** - Deployment commands

### CI/CD Pipeline:
- **GitHub Actions** - CI/CD platform
- **GitHub** - Source control
- **AWS CodeBuild** (alternative) - Build service
- **AWS Parameter Store** - Configuration management

### Development Tools:
- **TypeScript** - CDK infrastructure code
- **Python 3.13+** - Lambda functions
- **Node.js/npm** - CDK runtime and package management
- **HTML/CSS/JavaScript** - Web UI
- **pytest** - Lambda function testing
- **jest** - CDK/TypeScript testing
- **AWS SAM CLI** - Local Lambda testing

## Project Structure

```
vehicle-counting-system/
├── infrastructure/          # CDK infrastructure code (TypeScript)
│   ├── bin/                # CDK app entry points
│   │   └── app.ts         # Main CDK app
│   ├── lib/               # CDK stack definitions
│   │   ├── core-stack.ts  # Core infrastructure
│   │   ├── lambda-stack.ts # Lambda functions
│   │   └── api-stack.ts   # API Gateway
│   ├── test/              # CDK tests
│   ├── cdk.json          # CDK configuration
│   ├── package.json      # Node.js dependencies
│   └── tsconfig.json     # TypeScript configuration
├── lambda/                 # Lambda function code (Python)
│   ├── upload-handler/     # Upload handler function
│   ├── video-processor/    # Video processing function
│   ├── results-processor/  # Results processing function
│   ├── results-api/        # Results API function
│   ├── shared/            # Shared utilities
│   └── tests/             # Lambda function tests
├── web-ui/                # Frontend application
│   ├── index.html         # Main UI page
│   ├── css/              # Stylesheets
│   ├── js/               # JavaScript files
│   └── assets/           # Images, icons
├── .github/               # GitHub Actions workflows
│   └── workflows/
│       ├── deploy-dev.yml     # Development deployment
│       ├── deploy-prod.yml    # Production deployment
│       └── test.yml          # Testing pipeline
├── scripts/               # Deployment and utility scripts
├── docs/                 # Documentation
├── requirements.txt      # Python dependencies (Lambda)
├── package.json         # Node.js dependencies (CDK)
└── README.md           # Project documentation
```

## Implementation Phases

### Phase 1: Foundation & CI/CD (Week 1)
**Goal**: Set up project structure, basic CI/CD, and core infrastructure

#### 1.1 Project Setup (Day 1)
```bash
# Initialize project
mkdir vehicle-counting-system
cd vehicle-counting-system
git init

# Set up CDK with TypeScript
npm install -g aws-cdk
mkdir infrastructure
cd infrastructure
cdk init app --language typescript
npm install

# Set up Python environment for Lambda functions
cd ..
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows
pip install boto3 pytest
```

#### 1.2 Basic CI/CD Pipeline (Day 2-3)
**Create**: `.github/workflows/test.yml`
```yaml
name: Test Pipeline
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.13'
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install CDK dependencies
        run: |
          cd infrastructure
          npm install
      - name: Install Python dependencies
        run: |
          pip install boto3 pytest
      - name: Run Lambda tests
        run: pytest lambda/tests/
      - name: Build and test CDK
        run: |
          cd infrastructure
          npm run build
          npm test
          cdk synth
```

#### 1.3 Core Infrastructure Stack (Day 4-5)
**Create**: Basic S3 buckets and IAM roles
```typescript
// infrastructure/lib/core-stack.ts
import * as cdk from 'aws-cdk-lib';
import * as s3 from 'aws-cdk-lib/aws-s3';
import { Construct } from 'constructs';

export class CoreStack extends cdk.Stack {
  public readonly storageBucket: s3.Bucket;
  public readonly webBucket: s3.Bucket;

  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // S3 bucket for videos and results
    this.storageBucket = new s3.Bucket(this, 'StorageBucket', {
      removalPolicy: cdk.RemovalPolicy.DESTROY,
      lifecycleRules: [
        {
          expiration: cdk.Duration.days(30),
        },
      ],
    });

    // S3 bucket for web UI
    this.webBucket = new s3.Bucket(this, 'WebBucket', {
      websiteIndexDocument: 'index.html',
      publicReadAccess: true,
      removalPolicy: cdk.RemovalPolicy.DESTROY,
    });
  }
}
```

**Deliverables**:
- ✅ Project structure established
- ✅ Basic CI/CD pipeline working
- ✅ Core S3 buckets deployed
- ✅ CDK synthesis working

---

### Phase 2: Lambda Functions (Week 2)
**Goal**: Implement and test all Lambda functions

#### 2.1 Upload Handler Lambda (Day 1-2)
**Create**: `lambda/upload-handler/handler.py`
```python
import json
import boto3
import uuid
from datetime import datetime, timedelta

def lambda_handler(event, context):
    s3_client = boto3.client('s3')
    
    # Parse request
    body = json.loads(event['body'])
    filename = body['filename']
    filesize = body['filesize']
    
    # Generate job ID
    job_id = f"job-{uuid.uuid4().hex[:12]}"
    
    # Generate pre-signed URL
    key = f"uploads/{job_id}/{filename}"
    presigned_url = s3_client.generate_presigned_url(
        'put_object',
        Params={'Bucket': BUCKET_NAME, 'Key': key},
        ExpiresIn=3600
    )
    
    return {
        'statusCode': 200,
        'headers': {
            'Access-Control-Allow-Origin': '*',
            'Content-Type': 'application/json'
        },
        'body': json.dumps({
            'jobId': job_id,
            'uploadUrl': presigned_url
        })
    }
```

#### 2.2 Video Processor Lambda (Day 3)
**Create**: `lambda/video-processor/handler.py`
```python
import json
import boto3

def lambda_handler(event, context):
    rekognition = boto3.client('rekognition')
    s3_client = boto3.client('s3')
    
    # Parse S3 event
    for record in event['Records']:
        bucket = record['s3']['bucket']['name']
        key = record['s3']['object']['key']
        
        # Extract job ID from key
        job_id = key.split('/')[1]
        
        # Create processing marker
        s3_client.put_object(
            Bucket=bucket,
            Key=f"processing/{job_id}.processing",
            Body=""
        )
        
        # Start Rekognition job
        response = rekognition.start_label_detection(
            Video={'S3Object': {'Bucket': bucket, 'Name': key}},
            NotificationChannel={
                'TopicArn': SNS_TOPIC_ARN,
                'RoleArn': SNS_ROLE_ARN
            },
            JobTag=job_id
        )
        
    return {'statusCode': 200}
```

#### 2.3 Results Processor Lambda (Day 4)
**Create**: `lambda/results-processor/handler.py`

#### 2.4 Results API Lambda (Day 5)
**Create**: `lambda/results-api/handler.py`

**Deliverables**:
- ✅ All 4 Lambda functions implemented
- ✅ Unit tests for each function
- ✅ Local testing with SAM CLI
- ✅ Shared utilities module

---

### Phase 3: API Gateway & Integration (Week 3)
**Goal**: Connect Lambda functions with API Gateway and S3 events

#### 3.1 API Gateway Stack (Day 1-2)
**Create**: `infrastructure/lib/api-stack.ts`
```typescript
import * as cdk from 'aws-cdk-lib';
import * as apigateway from 'aws-cdk-lib/aws-apigateway';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import { Construct } from 'constructs';

export interface ApiStackProps extends cdk.StackProps {
  uploadHandler: lambda.Function;
  resultsApi: lambda.Function;
}

export class ApiStack extends cdk.Stack {
  public readonly api: apigateway.RestApi;

  constructor(scope: Construct, id: string, props: ApiStackProps) {
    super(scope, id, props);

    // API Gateway
    this.api = new apigateway.RestApi(this, 'VehicleAnalysisApi', {
      restApiName: 'Vehicle Analysis API',
      defaultCorsPreflightOptions: {
        allowOrigins: apigateway.Cors.ALL_ORIGINS,
        allowMethods: apigateway.Cors.ALL_METHODS,
        allowHeaders: ['Content-Type', 'Authorization'],
      },
    });

    // Upload endpoint
    const uploadIntegration = new apigateway.LambdaIntegration(
      props.uploadHandler
    );
    this.api.root.addResource('upload').addMethod('POST', uploadIntegration);

    // Results endpoint
    const resultsIntegration = new apigateway.LambdaIntegration(
      props.resultsApi
    );
    const resultsResource = this.api.root.addResource('results');
    resultsResource.addResource('{jobId}').addMethod('GET', resultsIntegration);
  }
}
```

#### 3.2 S3 Event Integration (Day 3)
**Add to core stack**: S3 event triggers for video processing

#### 3.3 SNS Integration (Day 4)
**Create**: SNS topics and subscriptions for Rekognition completion

#### 3.4 Integration Testing (Day 5)
**Create**: End-to-end integration tests

**Deliverables**:
- ✅ API Gateway configured and deployed
- ✅ S3 event triggers working
- ✅ SNS notifications functional
- ✅ Integration tests passing

---

### Phase 4: Web UI Development (Week 4)
**Goal**: Build and deploy the frontend application

#### 4.1 Basic HTML/CSS Structure (Day 1-2)
**Create**: `web-ui/index.html`
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Counting System</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Vehicle Analysis System</h1>
        </header>
        
        <div class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="videoInput" accept="video/*">
                <p>Drag & drop video file or click to browse</p>
                <div class="progress-bar" id="progressBar" style="display:none;">
                    <div class="progress-fill" id="progressFill"></div>
                    <span class="progress-text" id="progressText">0%</span>
                </div>
            </div>
        </div>
        
        <div class="jobs-section">
            <h2>Processing Jobs</h2>
            <div class="jobs-list" id="jobsList"></div>
        </div>
        
        <div class="results-section" id="resultsSection" style="display:none;">
            <h2>Analysis Results</h2>
            <div class="results-content" id="resultsContent"></div>
        </div>
    </div>
    
    <script src="js/app.js"></script>
</body>
</html>
```

#### 4.2 JavaScript Application Logic (Day 3-4)
**Create**: `web-ui/js/app.js`

#### 4.3 Responsive CSS Styling (Day 5)
**Create**: `web-ui/css/styles.css`

**Deliverables**:
- ✅ Complete web UI implemented
- ✅ Responsive design working
- ✅ File upload with progress tracking
- ✅ Real-time job status polling

---

### Phase 5: Deployment Automation (Week 5)
**Goal**: Automate deployment to different environments

#### 5.1 Environment Configuration (Day 1)
**Create**: Environment-specific configurations
```typescript
// infrastructure/lib/config.ts
export interface EnvironmentConfig {
  envName: string;
  account: string;
  region: string;
  domainName?: string;
}

export const ENVIRONMENTS: Record<string, EnvironmentConfig> = {
  dev: {
    envName: 'dev',
    account: '123456789012',
    region: 'us-east-1',
  },
  prod: {
    envName: 'prod',
    account: '123456789012',
    region: 'us-east-1',
  },
};
```

#### 5.2 Production Deployment Pipeline (Day 2-3)
**Create**: `.github/workflows/deploy-prod.yml`
```yaml
name: Deploy to Production
on:
  push:
    branches: [main]
    
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.13'
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Install dependencies
        run: |
          cd infrastructure
          npm install
          cd ..
          pip install boto3 pytest
      
      - name: Run tests
        run: |
          pytest lambda/tests/
          cd infrastructure
          npm run build
          npm test
      
      - name: Deploy infrastructure
        run: |
          cd infrastructure
          cdk deploy --all --require-approval never
      
      - name: Deploy web UI
        run: |
          aws s3 sync web-ui/ s3://vehicle-analysis-ui-prod/ --delete
```

#### 5.3 Development Environment (Day 4)
**Create**: Separate dev environment pipeline

#### 5.4 Rollback & Monitoring (Day 5)
**Add**: CloudWatch alarms and rollback procedures

**Deliverables**:
- ✅ Automated dev/prod deployments
- ✅ Environment-specific configurations
- ✅ Rollback procedures documented
- ✅ Basic monitoring in place

---

### Phase 6: Testing & Documentation (Week 6)
**Goal**: Comprehensive testing and documentation

#### 6.1 Unit Testing (Day 1-2)
**Expand**: Lambda function test coverage
```python
# lambda/tests/test_upload_handler.py
import pytest
import json
from moto import mock_s3
from upload_handler.handler import lambda_handler

@mock_s3
def test_upload_handler_success():
    # Test implementation
    pass
```

#### 6.2 Integration Testing (Day 3)
**Create**: End-to-end test scenarios

#### 6.3 Load Testing (Day 4)
**Create**: Performance tests for API endpoints

#### 6.4 Documentation (Day 5)
**Create**: Complete technical documentation

**Deliverables**:
- ✅ 90%+ test coverage for Lambda functions
- ✅ Integration tests for all workflows
- ✅ Performance benchmarks documented
- ✅ Complete technical documentation

---

## Optimal Feature Implementation Order

### Priority 1: Core Infrastructure (Must Have)
1. **S3 Buckets** - Storage foundation
2. **Upload Handler Lambda** - File upload capability
3. **Basic Web UI** - User interface for uploads
4. **API Gateway** - REST API endpoints

### Priority 2: Video Processing (Core Feature)
5. **Video Processor Lambda** - Rekognition integration
6. **Results Processor Lambda** - Data processing
7. **SNS Integration** - Job completion notifications
8. **S3 Event Triggers** - Automated processing

### Priority 3: Results & UX (User Experience)
9. **Results API Lambda** - Serve processed results
10. **Results Display UI** - Show analysis results
11. **Job Status Polling** - Real-time updates
12. **Download Functionality** - Export results

### Priority 4: Production Ready (Nice to Have)
13. **Error Handling** - Robust error management
14. **Monitoring & Logging** - CloudWatch integration
15. **Auto-cleanup** - Lifecycle policies
16. **Security Hardening** - IAM least privilege

## Development Methodology

### Sprint Structure (2-week sprints):
- **Sprint 1**: Foundation & Core Infrastructure (Phases 1-2)
- **Sprint 2**: API Integration & Web UI (Phases 3-4)
- **Sprint 3**: Deployment & Testing (Phases 5-6)

### Daily Workflow:
1. **Pull latest code** from main branch
2. **Create feature branch** for day's work
3. **Implement feature** with tests
4. **Run local tests** before commit
5. **Create pull request** for review
6. **Deploy to dev** environment for testing

### Quality Gates:
- **Code review** required for all PRs
- **All tests must pass** before merge
- **CDK synth successful** before deployment
- **Integration tests pass** in dev environment

## Risk Mitigation

### Technical Risks:
- **Rekognition limits**: Implement retry logic and error handling
- **Lambda timeouts**: Optimize code and increase timeout limits
- **S3 costs**: Implement lifecycle policies and monitoring
- **API rate limits**: Add throttling and caching

### Operational Risks:
- **Deployment failures**: Implement rollback procedures
- **Data loss**: Regular backups and versioning
- **Security vulnerabilities**: Regular security scans
- **Cost overruns**: Cost monitoring and alerts

## Success Metrics

### Technical Metrics:
- **Deployment success rate**: >95%
- **Test coverage**: >90%
- **API response time**: <2 seconds
- **Processing accuracy**: >85%

### Business Metrics:
- **System uptime**: >99%
- **User satisfaction**: Positive feedback
- **Cost efficiency**: Within budget projections
- **Time to market**: 6 weeks from start to production

---

This implementation plan provides a structured approach to building the entire vehicle counting system with modern DevOps practices. Each phase builds upon the previous one, ensuring a stable and scalable solution.